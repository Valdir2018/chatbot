<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Mini Chatbot</title>
    <link rel="stylesheet" type="text/css" href="./public/css/style.css?1400">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script type="text/javascript" src="./public/js/transition.min.js"></script>

</head>
<body>



	<form action="">
		<label for="">Selecione um tema:</label>
        <input type="color" id="favcolor" name="favcolor" value="#ff0000">
    </form>


    <script>


    	

    	document.querySelector('[name="favcolor"]').addEventListener('change', getBackground);

    	function getBackground(e) {
    		 const response = new XMLHttpRequest();
    		
    		let color = {
    			background: e.target.value
    		};

    		let newObject = JSON.stringify(color);

    		response.open('POST', './components/Layout.php', true);
    		response.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		    response.setRequestHeader("Cache-Control", "no-cache, no-store max-age=0");
		    response.setRequestHeader("Expires", "Tue, 01 Jan 1980 1:00:00 GMT");
		    response.setRequestHeader("Pragma", "no-cache");

    		response.onreadystatechange = function() {
    			if (response.readyState === 4 && response.status === 200) {
    				let data = JSON.parse(response.responseText);
					for(var x of data) {
			            let header = document.querySelector('#header');
			            header.style.background = x.background;
    	            }
    			}
    		}
    		 response.send('color='+newObject);
    	}


		async function setTheme() {
			const response = await fetch(
				'components/styles/main.json', 
			    {cache: "reload"}
			);
			
			const result = await response.json();

			for(var x of result) {
				document.querySelector('#header').style.background = x.background;
			}
		}

		setTheme();
    	
    </script>

	<header id="header">
		<nav class="flex-menu">
			<ul>
				<li><a href="create.html">
					<span class="material-icons">add</span>Cadastrar</a>
				</li>
				
				<li><a href="list.html">
					<span class="material-icons">question_answer</span>Diálogos</a>
				</li>
			</ul>
		</nav>
	</header>

	

    <div class="box flex-animate-bottom" data-id="0">
		
		<div class="popup-content">
			<span id="innerHTML" class="dialog-transition">Olá, eu sou o Will, posso te ajudar ? <br/> Informe o termo que deseja encontrar, ex: <br/><br/>
			1. Inteligência Artificial <br/> 2. Engenharia de Software <br/> 3. Criptografia</span>
		</div>

		<div>
			<div class="box-header"><span class="material-icons" id="btn-close">close</span></div>
			 <div class="flex-item-search">
				 <div id="search">
					<input type="text" name="keyword" id="keyword" placeholder="Digite aqui o que deseja" >
					<button type="button" class="search">Buscar</button>
				 </div>
				 <div class="box-footer"></div>
			 </div>
		</div>
	</div>
	<div class="item-active">
		<a id="icone">
			<img src="./public/images/580b57fbd9996e24bc43be11.png" id="imagem" onmouseenter="toggleImageMouseEnter(this)"  
			onmouseout="toggleImageMouseOut(this)">
		</a>
	</div>

    <script type="text/javascript">

	const OPTIONS_MENU = `Olá, eu sou o Will, posso te ajudar ? <br/> 
		    Informe o termo que deseja encontrar, ex: <br/><br/>
			1. Inteligência Artificial <br/> 
			2. Engenharia de Software <br/> 
			3. Criptografia`;

    
	const icon = document.getElementById('icone');
    const button = document.querySelector('.search');
    const close = document.getElementById('btn-close');
	const inputOnKeyUp = document.getElementById('keyword');
    var box = document.getElementsByClassName('box')[0];

	var span = document.getElementById('innerHTML');
	var imagem = document.getElementById('imagem');
      
	icone.addEventListener('click', animate);   
	button.addEventListener('click', handleChangedKeyword);
    close.addEventListener('click', hideElement);
	
	inputOnKeyUp.addEventListener("keyup", onChangeKeypress);
	inputOnKeyUp.addEventListener("keyup", onFieldIsEmpty);

    window.addEventListener('keyup', function(e) {
		var keyword = document.getElementById('keyword');
	});

	function onChangeKeypress(e) {
		let keypress = e.which || e.keyCode;
		var keyword = document.getElementById('keyword');
		
		if (keypress === 13) 
			handleChangedKeyword();
	}

	function onFieldIsEmpty(e) {
		const field = e.target.value;
		if (field.length <= 0 ) {
			span.innerHTML = '';
		    span.innerHTML = OPTIONS_MENU;
		}
	}

    function hideElement(event) {
        animate(event);

		span.innerHTML = ''; 
		span.innerHTML = valor.text;
    }
      
    function animate(element) {
	    if (box._side == "top") {
	        box._side = "bottom";
	        box.classList.add('box-active');
	        transition.begin(box, "transform translateY(700px) translateY(0) 1s", {
	            beginFromCurrentValue: true
	        });

	    } else {
	       box._side = "top";
	       transition.begin(box, "transform translateX(0) translateY(650px) 0.4s", {
	            beginFromCurrentValue: true
	       });
	    }
	  }


	async function handleChangedKeyword() {
		  let context = keyword.value;
		  context = context.toLowerCase();
		  const response = await fetch('data/keyword.json', {cache: "reload"});

		  const result = await response.json();
		  
		  if (!response.ok) {
			  throw new Error("HTTP error, status = " + response.status);
		  }

		  const data =  result.filter(item => item.keyword === context);
          
		  if (data.length == 0 || data === null) {
			  span.innerHTML = ''; 
			  notifyAudio(data);

			  span.innerHTML = messageFromInnerHtml(keyword);
			  return;
		  }

		  data.forEach(function(valor) {
			   span.innerHTML = ''; 
			   span.innerHTML = valor.text;
		  });
		  
		  notifyAudio(data);
	}

	function messageFromInnerHtml(term) {
	  	let termo = term.value;

		let message = 
		  `Ops ! Ainda não sei responder sobre o termo: <span id="word"> ${term.value} </span> tente pesquisar por: ` + termo.toUpperCase();
		  return message;
	}

	function toggleImageMouseEnter(image) {
		  image.src = "./public/images/580b57fbd9996e24bc43be11.png";
	}

	function toggleImageMouseOut(image) {
		  image.src = "./public/images/580b57fbd9996e24bc43be10.png";
	}

	function notifyAudio(data) {
		  if (data.length !== 0) {
			 return  new Audio('./public/audio/206875133.mp3').play();
		  }
		  return new Audio('./public/audio/notification.mp3').play();
	}


    </script>

    
</body>
</html>